volumes:
  data:
    driver: local
    driver_opts:
      type: nfs
      o: addr=192.168.1.244,rw,vers=4.1
      device: ":/mnt/MAIN_POOL/data/docker-volumes"

secrets:
  dococd-secrets-client-secret:
    external: true
  dococd-git-access-token:
    external: true
  dococd-api-secret:
    external: true
  dococd-webhook-secret:
    external: true

networks:
  cloudflare-net:
    external: true

services:
  init_volumes:
    user: "3004:3004"
    image: busybox
    command: >
      sh -c "mkdir -p /mnt/docker-volumes/doco-cd-data"
    deploy:
      replicas: 1
      mode: replicated-job
    volumes:
      - type: volume
        source: data
        target: /mnt/docker-volumes
        volume:
          nocopy: true
  app:
    image: ghcr.io/kimdre/doco-cd:0.61.0
    secrets:
      - dococd-secrets-client-secret
      - dococd-git-access-token
      - dococd-api-secret
      - dococd-webhook-secret
    environment:
      TZ: Europe/Zurich
      API_SECRET_FILE: /run/secrets/dococd-api-secret
      GIT_ACCESS_TOKEN_FILE: /run/secrets/dococd-git-access-token
      WEBHOOK_SECRET_FILE: /run/secrets/dococd-webhook-secret
      SECRET_PROVIDER: infisical
      SECRET_PROVIDER_SITE_URL: https://eu.infisical.com
      SECRET_PROVIDER_CLIENT_ID: 6f8e00f0-daad-4a0c-9e86-e02e12ddb297
      SECRET_PROVIDER_CLIENT_SECRET_FILE: /run/secrets/dococd-secrets-client-secret
      DOCKER_QUIET_DEPLOY: "false"
      LOG_LEVEL: info
    depends_on:
      - init_volumes
    networks:
      cloudflare-net:
        aliases:
          - doco-cd
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.http.routers.doco-cd.rule=Host(`doco-cd.lab.schaermu.ch`)"
        - "traefik.http.routers.doco-cd.entrypoints=websecure"
        - "traefik.http.services.doco-cd.loadbalancer.server.port=80"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - type: volume
        source: data
        target: /data
        volume:
          subpath: doco-cd-data
          nocopy: true
    healthcheck:
      test: [ "CMD", "/doco-cd", "healthcheck" ]
      start_period: 15s
      interval: 30s
      timeout: 5s
      retries: 3