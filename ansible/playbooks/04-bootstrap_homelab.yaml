- name: Deploy initial secrets
  hosts: managers[0]
  tasks:
    - name: Look for secret files
      delegate_to: localhost
      ansible.builtin.find:
        paths:
          - "../../secrets"
        file_type: file
        patterns:
          - '*'
        read_whole_file: false
        recurse: true
      register: secret_type_files
    - name: Create docker secrets
      community.docker.docker_secret:
        name: "{{ item.path | basename }}"
        data: "{{ lookup('file', item.path) | b64encode }}"
        data_is_b64: true
        state: present
      loop: "{{ secret_type_files.files }}"

- name: Create default overlay networks
  hosts: managers[0]
  become: true
  tasks:
    - name: Create overlay networks
      community.docker.docker_network:
        name: "{{ item.name }}"
        driver: overlay
        attachable: true
        state: present
        ipam_config:
          - subnet: "{{ item.ipam_subnet }}"
            gateway: "{{ item.ipam_gateway }}"
      loop:
        - { name: traefik-public, ipam_subnet: 10.0.10.0/24, ipam_gateway: 10.0.10.1 }
        - { name: cloudflare-net, ipam_subnet: 10.0.11.0/24, ipam_gateway: 10.0.11.1 }
        - { name: metric-net, ipam_subnet: 10.0.12.0/24, ipam_gateway: 10.0.12.1 }

- name: Deploy initial stacks
  hosts: managers[0]
  tasks:
    - name: Set stack list
      ansible.builtin.set_fact:
        stack_list:
          - doco-cd-docker-compose.yaml
          - cloudflared-docker-compose.yaml
    
    - name: Copy stack files
      ansible.builtin.copy:
        src: "./files/{{ item }}"
        dest: "/tmp/{{ item }}"
      loop: "{{ stack_list }}"
    
    - name: Deploy stacks
      community.docker.docker_stack:
        name: bootstrap
        state: present
        compose:
          - /tmp/{{ item }}
      loop: "{{ stack_list }}"