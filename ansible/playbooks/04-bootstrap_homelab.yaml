- name: Load secrets from Infisical
  hosts: managers[0]
  tasks:
    - name: Set Infisical variables from env
      ansible.builtin.set_fact:
        server_url: "{{ lookup('env', 'TF_VAR_infisical_server_url') }}"
        project_id: "{{ lookup('env', 'TF_VAR_infisical_workspace_id') }}"
        client_id: "{{ lookup('env', 'TF_VAR_infisical_client_id') }}"
        client_secret: "{{ lookup('env', 'TF_VAR_infisical_client_secret') }}"

    - name: Login to Infisical
      infisical.vault.login:
        url: "{{ server_url }}"
        auth_method: universal_auth
        universal_auth_client_id: "{{ client_id }}"
        universal_auth_client_secret: "{{ client_secret }}"
      register: infisical_login

    - name: Compile DocoCD .env file from jinja2 template
      ansible.builtin.set_fact:
        dococd_env_content: "{{ lookup('template', './files/.env.dococd.j2', secrets=secrets, infisical_site_url=server_url) }}"
      vars:
        secrets: "{{ lookup('infisical.vault.read_secrets', as_dict=True, login_data=infisical_login.login_data, project_id=project_id, path='/_ansible', env_slug='prod') }}"
    
    - name: Create docker secret for DocoCD .env
      community.docker.docker_secret:
        name: dotenv-dococd
        state: present
        data: "{{ dococd_env_content | b64encode }}"
        data_is_b64: true
    
    - name: Create docker secret for Cloudflare Tunnel credentials
      community.docker.docker_secret:
        name: cloudflare-tunnel-token
        state: present
        data: "{{ secrets['CLOUDFLARE_TUNNEL_TOKEN'] | b64encode }}"
        data_is_b64: true
      vars:
        secrets: "{{ lookup('infisical.vault.read_secrets', as_dict=True, login_data=infisical_login.login_data, project_id=project_id, path='/_ansible', env_slug='prod', secret_name='CLOUDFLARE_TUNNEL_TOKEN') }}"

- name: Create default overlay networks
  hosts: managers[0]
  become: true
  tasks:
    - name: Create overlay networks
      community.docker.docker_network:
        name: "{{ item.name }}"
        driver: overlay
        attachable: true
        state: present
        ipam_config:
          - subnet: "{{ item.ipam_subnet }}"
            gateway: "{{ item.ipam_gateway }}"
      loop:
        - { name: traefik-public, ipam_subnet: 10.0.10.0/24, ipam_gateway: 10.0.10.1 }
        - { name: cloudflare-net, ipam_subnet: 10.0.11.0/24, ipam_gateway: 10.0.11.1 }
        - { name: metric-net, ipam_subnet: 10.0.12.0/24, ipam_gateway: 10.0.12.1 }

- name: Deploy initial stacks
  hosts: managers[0]
  tasks:
    - name: Set stack list
      ansible.builtin.set_fact:
        stack_list:
          - doco-cd-docker-compose.yaml
          - cloudflared-docker-compose.yaml
    
    - name: Copy stack files
      ansible.builtin.copy:
        src: "./files/{{ item }}"
        dest: "/tmp/{{ item }}"
      loop: "{{ stack_list }}"
    
    - name: Deploy stacks
      community.docker.docker_stack:
        name: bootstrap
        state: present
        compose:
          - /tmp/{{ item }}
      loop: "{{ stack_list }}"