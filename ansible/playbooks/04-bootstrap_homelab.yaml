- name: Create bootstrap secrets
  hosts: managers[0]
  tasks:
    - name: Read secrets from Infisical
      ansible.builtin.include_role:
        name: infisical
        public: true
      when: true

    - name: Create docker secrets for DocoCD
      become: true
      community.docker.docker_secret:
        name: "{{ item.name }}"
        state: present
        data: "{{ item.value | b64encode }}"
        data_is_b64: true
      loop:
        - name: dococd-secrets-client-secret
          value: "{{ secrets.secrets['DOCOCD_SECRET_PROVIDER_CLIENT_SECRET'] }}"
        - name: dococd-git-access-token
          value: "{{ secrets.secrets['DOCOCD_GIT_ACCESS_TOKEN'] }}"
        - name: dococd-api-secret
          value: "{{ secrets.secrets['DOCOCD_API_SECRET'] }}"
        - name: dococd-webhook-secret
          value: "{{ secrets.secrets['DOCOCD_WEBHOOK_SECRET'] }}"
    
    - name: Create docker secret for Cloudflare Tunnel credentials
      become: true
      community.docker.docker_secret:
        name: cloudflare-tunnel-token
        state: present
        data: "{{ secrets.secrets['CLOUDFLARE_TUNNEL_TOKEN'] | b64encode }}"
        data_is_b64: true

- name: Create default overlay networks
  hosts: managers[0]
  become: true
  tasks:
    - name: Create overlay networks
      community.docker.docker_network:
        name: "{{ item.name }}"
        driver: overlay
        attachable: true
        state: present
        ipam_config:
          - subnet: "{{ item.ipam_subnet }}"
            gateway: "{{ item.ipam_gateway }}"
      loop:
        - { name: traefik-public, ipam_subnet: 10.0.10.0/24, ipam_gateway: 10.0.10.1 }
        - { name: cloudflare-net, ipam_subnet: 10.0.11.0/24, ipam_gateway: 10.0.11.1 }
        - { name: metric-net, ipam_subnet: 10.0.12.0/24, ipam_gateway: 10.0.12.1 }

- name: Deploy initial stacks
  hosts: managers[0]
  become: true
  tasks:
    - name: Set stack list
      ansible.builtin.set_fact:
        stack_list:
          - { name: "doco-cd", file: "doco-cd-docker-compose.yaml" }
          - { name: "cloudflared", file: "cloudflared-docker-compose.yaml" }
    
    - name: Copy stack files
      ansible.builtin.copy:
        src: "./files/{{ item.file }}"
        dest: "/tmp/{{ item.file }}"
      loop: "{{ stack_list }}"
    
    - name: Deploy stacks
      community.docker.docker_stack:
        name: "{{ item.name }}"
        state: present
        compose:
          - /tmp/{{ item.file }}
      loop: "{{ stack_list }}"
  tags:
    - bootstrap